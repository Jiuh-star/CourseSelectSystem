const parser = new DOMParser();

function loadXMLDoc(requestObj, method = 'GET', params = "", startFunc = null, endFunc = null) {
    let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && (this.status == 200 || this.status == 404 || this.status == 403)) {
            let doc = parser.parseFromString(xhttp.responseText, "text/html");
            document.getElementById("container").innerHTML = doc.getElementsByClassName("container-fluid")[0].innerHTML;
            if (doc.title) {
                document.getElementById('heading').innerText = doc.title;
            }
            if (endFunc != null) {
                endFunc();
            }
        } else if (this.readyState == 4 && this.status >= 500) {
            alert('服务器错误，请稍后重试！')
            if (endFunc != null) {
                endFunc();
            }
        }
        if (this.readyState == 1 && startFunc != null) {
            startFunc();
        }
    }
    if (method == 'GET') {
        requestObj += '?' + params;
    }
    xhttp.open(method, requestObj, true);
    if (method == 'POST') {
        const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
        params += '&csrfmiddlewaretoken=' + csrfToken;
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    }
    xhttp.send(params);
}

function submitSearch(formName = 'form', method = 'POST', destination = 'stu/all-courses', submitId = 'submitSearchButton') {
    let params = '';
    let items = document.forms[formName].getElementsByTagName('input');
    for (let item of items) {
        let value = item.value;
        params += value ? item.name + '=' + value + '&' : '';
    }
    items = document.forms[formName].getElementsByTagName('select')
    for (let item of items) {
        let value = item.value;
        params += value ? item.name + '=' + value + '&' : '';
    }
    loadXMLDoc(destination, method, params, startFunc = function () {
            let btn = document.getElementById(submitId);
            let i = btn.getElementsByTagName('i')[0]
            i.className = 'fa fa-hourglass-end';
            btn.disabled = true;
        },
        endFunc = function () {
            let btn = document.getElementById(submitId);
            let i = btn.getElementsByTagName('i')[0];
            i.className = 'fa fa-search';
            btn.disabled = false;
        });
}

function limitChange(dst, id) {
    let value = document.getElementById(id).value;
    loadXMLDoc(dst + '?page=1&limit=' + value, 'GET', '', null, loadSearchFunc);
}

function loadSearchFunc() {
    let search = document.getElementById('search');
    search.onkeypress = function (event) {
        if (event.keyCode == 13) {
            loadXMLDoc('stu/selection?q=' + search.value, 'GET', '', null, loadSearchFunc);
        }
    }
}

function selectThisCourse(arrangementId, elementId, isRemove = false) {
    const element = document.getElementById(elementId);
    if (element == null || !element.hasAttribute('href')) {
        return;
    }
    if (isRemove && !confirm('此操作不可逆转，确定退课？')) {
        return;
    }
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState == 4) {
            if (this.status == 200) {
                element.removeAttribute('href');
                element.innerText = isRemove ? '已退' : '已选';
            } else {
                alert(xhttp.responseText);
            }
        }
    }
    xhttp.open('POST', "./stu/select-course", true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
    xhttp.send('arrangementId=' + arrangementId + '&csrfmiddlewaretoken=' + csrfToken + '&isRemove=' + (isRemove ? 'true' : ''));
}

function flashBarColor() {
    bars = document.getElementsByClassName('progress-bar');
    for (bar of bars) {
        const reg = new RegExp('bg-\\S+');
        const width = bar.getAttribute('aria-valuenow');
        const color = width > 50 ? (width > 80 ? 'bg-danger' : 'bg-warning') : 'bg-success'
        bar.className = bar.className.replace(reg, color);
    }
}

(function ($) {
    "use strict"
    $("#sidebarToggle, #sidebarToggleTop").on('click',
        function (e) {
            $("body").toggleClass("sidebar-toggled");
            $(".sidebar").toggleClass("toggled");
            if ($(".sidebar").hasClass("toggled")) {
                $('.sidebar .collapse').collapse('hide');
            }
        });
    $(window).resize(function () {
        if ($(window).width() < 768) {
            $('.sidebar .collapse').collapse('hide');
        }
    });
    $('body.fixed-nav .sidebar').on('mousewheel DOMMouseScroll wheel',
        function (e) {
            if ($(window).width() > 768) {
                var e0 = e.originalEvent,
                    delta = e0.wheelDelta || -e0.detail;
                this.scrollTop += (delta < 0 ? 1 : -1) * 30;
                e.preventDefault();
            }
        });
    $(document).on('scroll',
        function () {
            var scrollDistance = $(this).scrollTop();
            if (scrollDistance > 100) {
                $('.scroll-to-top').fadeIn();
            } else {
                $('.scroll-to-top').fadeOut();
            }
        });
    $(document).on('click', 'a.scroll-to-top',
        function (e) {
            var $anchor = $(this);
            $('html, body').stop().animate({
                    scrollTop: ($($anchor.attr('href')).offset().top)
                },
                1000, 'easeInOutExpo');
            e.preventDefault();
        });
})(jQuery);

function loadChart() {
    $("[data-bs-chart]").each((function (e, t) {
        this.chart = new Chart($(t), $(t).data("bs-chart"));
    }));
}

function checkForm(name) {
    const form = document.forms[name]

    if (!form) {
        return false;
    }
    const inputs = form.getElementsByTagName('input');
    if (inputs.length <= 2) {
        return false;
    }
    for (input of inputs) {
        if (!input.value) {
            return false;
        }
    }
    return true;
}

function sleep(ms) {
    return new Promise(resolve => {
        setTimeout(resolve, ms);
    });
}

function submitScores(name, href = '/teac/scores') {
    if (!confirm('提交后不可更改，确定继续？')) {
        return;
    }
    if (checkForm(name)) {
        const form = document.forms[name]
        form.submit();
        sleep(1000).then(function () {
            const arrId = document.getElementById('arrId').value
            loadXMLDoc(href + '?arrangementId=' + arrId, 'GET', '', null,
                function () {
                    const f = document.forms[name]
                    if (f.length <= 2) {
                        return alert('提交成功！\n如果错误请联系管理员修改！');
                    }
                    return alert('提交失败，请检查网络连接，或稍后重试！');
                }
            );
        });
    } else {
        alert('提交失败，请检查！');
    }
}

function showModal(remoteUrl, data = '', modalId = '#modal', callback = null) {
    $(modalId).on('show.bs.modal', function (e) {
        $(modalId).find('.modal-content').html('检索中，请稍后...');
    });
    $(modalId).modal('show');
    $(modalId).find('.modal-content').load(remoteUrl, data, callback);
}